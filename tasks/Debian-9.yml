---
- name: Remove older versions of Docker(including those in main debian repos)
  apt:
    name: "{{ packages }}"
    state: absent
  vars:
   packages:
   - docker
   - docker-engine
   - docker.io
   - containerd
   - runc

- name: Update apt
  apt:
    update_cache: yes
    upgrade: dist

- name: Install needed packages for Docker
  apt:
    name: "{{ packages }}"
    install_recommends: no
  vars:
   packages:
   - apt-transport-https
   - ca-certificates
   - curl
   - gnupg2
   - software-properties-common

- name: Add docker's apt key
  apt_key:
    url: 'https://download.docker.com/linux/debian/gpg'
    state: present
    id: 9DC858229FC7DD38854AE2D88D81803C0EBFCD88

- name: Setup the docker apt repo
  lineinfile:
    line: 'deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable'
    path: /etc/apt/sources.list.d/docker-ce.list
    create: yes
    owner: root
    group: root
    mode: 0644
    state: present

- name: Install docker packages
  apt:
    name: "{{ packages }}"
    update_cache: yes
    install_recommends: no
  vars:
   packages:
   - docker-ce
   - docker-ce-cli
   - containerd.io
   # python docker is req for ansible for mod ansible_docker
   - python-docker
   install_recommends: no
  notify: "restart docker"

- name: Add my user to docker
  user:
   name: "{{ username }}"
   comment: user
   # this is optional
   # but conflicts with some cloud images
   # eg ovh, digitalocean has debian users with uid 1000
   # uid: "{{ uid }}"
   groups: docker
   append: yes
   state: present

- name: Install backported docker compose
  apt:
    name: "{{ packages }}"
    update_cache: yes
    default_release: "{{ ansible_distribution_release }}-backports"
  vars:
   packages:
   - docker-compose

#- name: Create /etc/systemd/system/docker.service.d
  #file:
    #path: /etc/systemd/system/docker.service.d
    #state: directory
    #mode: 0755

#- name: Enable remote access
  #template:
    #src: templates/override.conf.j2
    #dest: /etc/systemd/system/docker.service.d/override.conf
    #owner: root
    #group: root
    #mode: 0644

#- name: Reload systemctl daemon
#  command: systemctl daemon-reload
